<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>じゃがバター順番待ち</title>
    <style>
        body { font-family: 'Helvetica Neue', 'Arial', sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #4a4a4a; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; background-color: #5cb85c; color: white; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; }
        button:hover { background-color: #4cae4c; }
        .reservation-info { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        .reservation-info h2 { text-align: center; color: #555; }
        .info-item { font-size: 18px; margin-bottom: 10px; }
        .cancel-btn { background-color: #d9534f; margin-top: 10px; }
        .cancel-btn:hover { background-color: #c9302c; }
    </style>
</head>
<body>

<div class="container">
    <h1>3年3組 じゃがバター販売</h1>
    <p>人数を選んで予約してください（最大3名まで）</p>

    <div id="reservation-form">
        <label for="people">予約人数：</label>
        <select id="people">
            <option value="1">1人</option>
            <option value="2">2人</option>
            <option value="3">3人</option>
        </select>
        <button id="reserve-btn">予約する</button>
    </div>

    <div id="reservation-info" class="reservation-info" style="display:none;">
        <h2>あなたの予約情報</h2>
        <div class="info-item">受付番号: <span id="my-reservation-number"></span></div>
        <div class="info-item">現在の待ち組数: <span id="my-waiting-count"></span></div>
        <div class="info-item">おおよその待ち時間: <span id="my-waiting-time"></span></div>
        <button class="cancel-btn" id="cancel-my-reservation-btn">予約をキャンセルする</button>
    </div>
</div>

<script>
    // ★ ここにデプロイしたウェブアプリのURLを貼り付けてください
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSxd4wyz8X2euEtjLck8By_pf_G0LWV1-eu39G1bzGMsrBM1NQILc-zDRUKcPpHRWkwg/exec';
    
    // 15分あたりに生産できるじゃがバターの数
    const PRODUCTION_RATE_PER_15_MINS = 19; 
    // 1分あたりの生産率
    const TOTAL_PRODUCTION_RATE_PER_MIN = PRODUCTION_RATE_PER_15_MINS / 15;
    
    let myReservationNumber = null;
    let baseWaitTimeAdjustment = 0;

    window.onload = function() {
        const storedNumber = localStorage.getItem('myReservationNumber');
        if (storedNumber) {
            myReservationNumber = parseInt(storedNumber);
            document.getElementById('reservation-form').style.display = 'none';
            document.getElementById('reservation-info').style.display = 'block';
            updateDisplay();
        }
        // 15秒ごとに表示を更新
        setInterval(updateDisplay, 15000); 
    };

    document.getElementById('reserve-btn').addEventListener('click', function() {
        const people = document.getElementById('people').value;
        const formData = new FormData();
        formData.append('action', 'reserve');
        formData.append('people', people);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                myReservationNumber = data.reservationNumber;
                localStorage.setItem('myReservationNumber', myReservationNumber);
                alert('予約が完了しました！あなたの受付番号は ' + myReservationNumber + ' です。');
                document.getElementById('reservation-form').style.display = 'none';
                document.getElementById('reservation-info').style.display = 'block';
                updateDisplay();
            } else {
                alert('予約に失敗しました。もう一度お試しください。');
            }
        }).catch(error => {
            console.error('予約エラー:', error);
            alert('通信エラーが発生しました。');
        });
    });

    async function updateDisplay() {
        try {
            // 管理者側で設定した待ち時間調整を取得
            const adjustmentResponse = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'getWaitTimeAdjustment' }),
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            });
            const adjustmentData = await adjustmentResponse.json();
            if (adjustmentData.success) {
                baseWaitTimeAdjustment = adjustmentData.adjustment;
            }

            // 待ちリストを取得
            const reservationResponse = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'getReservations' }),
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            });
            const reservationData = await reservationResponse.json();

            if (reservationData.success) {
                const reservations = reservationData.reservations;
                if (myReservationNumber) {
                    const myIndex = reservations.findIndex(r => r.reservationNumber === myReservationNumber);
                    if (myIndex !== -1) {
                        const waitingCount = myIndex;
                        const totalPeopleAhead = reservations.slice(0, myIndex).reduce((sum, res) => sum + res.people, 0);
                        // 待ち時間の計算
                        const waitTime = Math.ceil(totalPeopleAhead / TOTAL_PRODUCTION_RATE_PER_MIN) + baseWaitTimeAdjustment;

                        document.getElementById('my-reservation-number').textContent = myReservationNumber;
                        document.getElementById('my-waiting-count').textContent = waitingCount;
                        document.getElementById('my-waiting-time').textContent = `${waitTime}分`;
                    } else {
                        // 予約が完了またはキャンセルされた場合
                        alert('あなたの順番が回ってきたか、予約がキャンセルされました。');
                        clearMyReservation();
                    }
                }
            }
        } catch (error) {
            console.error('表示更新エラー:', error);
        }
    }

    document.getElementById('cancel-my-reservation-btn').addEventListener('click', function() {
        if (!confirm('本当に予約をキャンセルしますか？')) {
            return;
        }

        const formData = new FormData();
        formData.append('action', 'cancelReservation');
        formData.append('reservationNumber', myReservationNumber);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(() => {
            alert('予約をキャンセルしました。');
            clearMyReservation();
        }).catch(error => {
            console.error('キャンセルエラー:', error);
        });
    });

    function clearMyReservation() {
        localStorage.removeItem('myReservationNumber');
        myReservationNumber = null;
        document.getElementById('reservation-form').style.display = 'block';
        document.getElementById('reservation-info').style.display = 'none';
        location.reload();
    }
</script>

</body>
</html>
